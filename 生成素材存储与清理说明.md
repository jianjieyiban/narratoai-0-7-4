## 生成素材存储与清理说明

生成脚本、配音、剪辑视频和字幕的过程中，程序会在多个目录写入临时文件与成品文件。下表对主要文件类型、默认路径和清理方式做一览说明，便于定位和管理。

| 类型 | 内容说明 | 默认路径 | 清理建议 |
| --- | --- | --- | --- |
| 源视频 | 用户上传或复制到项目的原始视频文件 | `resource/videos/` | 仅保留仍需使用的源视频；不再使用时可直接删除对应 MP4。 |
| 生成脚本 (JSON) | `AI生成画面解说脚本` 输出的文案脚本（含 `picture` / `narration` / `duration` / `editedTimeRange` 等字段，流程会自动更新时间轴） | `resource/scripts/` | 若脚本较多，可手动删除过期文件。注意不要删除 `resource/templates/` 下的模板脚本。 |
| 关键帧缓存 | 由视觉分析生成的关键帧 JPG，按视频哈希归档 | `storage/temp/keyframes/<video_hash>/` | 清理单个视频：删除对应哈希目录；清理全部：删除 `storage/temp/keyframes` 整个目录。 |
| 视频帧分析结果 | 视觉模型输出的 `frame_analysis_YYYYMMDD_HHMM.json` | `storage/temp/analysis/` | 删除文件可强制重新分析；若只保留最新一次，可删除旧日期文件。 |
| TTS 片段音频 & 字幕 | 每个 OST=0/2 片段生成的 `audio_*.mp3` 与 `subtitle_*.srt` | `storage/tasks/<任务ID>/` | 任务完成后，如无需留存，可删除整个任务目录。 |
| 裁剪后的视频片段 | `clip_video_unified` 生成的子视频，命名格式 `vid_起止时间.mp4` | `storage/temp/clip_video_unified/<task_hash>/` | 完成后可删除 `storage/temp/clip_video_unified` 目录释放空间。 |
| 裁剪旧目录 (兼容) | 旧版 `storage/temp/clip_video/` | `storage/temp/clip_video/` | 若使用新版流程，可清空此目录。 |
| 合并中间视频 | `merger.mp4`：拼接片段后的临时视频 | `storage/tasks/<任务ID>/merger.mp4` | 若仅需最终成品，可删除。 |
| 最终成品视频 | `combined.mp4`：配音+BGM+字幕合成后的成片 | `storage/tasks/<任务ID>/combined.mp4` | 最终输出。发布后若不再需要，可删除任务目录。 |
| 合并后的配音 | `merger_audio.mp3`：所有配音段落合并后的音频 | `storage/tasks/<任务ID>/merger_audio.mp3` | 如需备份配音可留存，否则可删除。 |
| 合并后的字幕 | `merged_subtitle_*.srt`：所有字幕拼接后的成品 | `storage/tasks/<任务ID>/merged_subtitle_*.srt` | 用于上传字幕平台；无需时可删除。 |
| 临时字幕/日志 | 生成字幕过程中的临时文件 | `storage/tasks/<任务ID>/subtitle_temp/`（按需创建） | 任务完成后可整体删除该子目录。 |

### 前端快捷清理

在 Web UI 的 **系统设置** 面板中提供以下常用缓存清理按钮：

- **Clear frames**：清空 `storage/temp/keyframes`。
- **清理分析结果**：清空 `storage/temp/analysis`。
- **Clear clip videos**：清空旧版 `storage/temp/clip_video`（若存在）。
- **Clear tasks**：清空 `storage/tasks`（慎用，会删除成品）。
- **🗑️ 一键清理所有缓存**：删除关键帧、分析结果、剪辑片段等临时目录，适合重新生成前统一清理。

### PowerShell 清理示例

若需要通过命令行手动清理，可在项目根目录执行：

```powershell
# 删除关键帧缓存
Remove-Item -LiteralPath 'storage/temp/keyframes' -Recurse -Force -ErrorAction SilentlyContinue

# 删除帧分析结果
Remove-Item -LiteralPath 'storage/temp/analysis' -Recurse -Force -ErrorAction SilentlyContinue

# 删除裁剪片段缓存
Remove-Item -LiteralPath 'storage/temp/clip_video_unified' -Recurse -Force -ErrorAction SilentlyContinue

# 删除所有任务输出（包含成品视频/字幕/音频）
Remove-Item -LiteralPath 'storage/tasks' -Recurse -Force -ErrorAction SilentlyContinue
```

若仅需删除某个任务，可改为：

```powershell
Remove-Item -LiteralPath 'storage/tasks/<任务ID>' -Recurse -Force
```

### 使用提醒

1. **保留成品**：清理前，如需备份 `combined.mp4`、`merged_subtitle_*.srt` 等，请先复制到安全位置。
2. **视频源文件**：上传新视频后，如与旧文件同名，建议重新命名避免混淆，并在界面中重新选择，确保流程读取到正确的源文件。
3. **脚本同步**：每次生成视频时，系统会把最新的 `duration` / `editedTimeRange` 写回脚本 JSON，便于确认字幕时间轴。
4. **日志排查**：若生成过程发生错误，可查看 Streamlit 控制台日志或对应任务目录下的输出记录进行排查。

掌握以上路径与清理方法，就能快速定位每类生成素材；当需要重新生成或释放空间时，也能有针对性地保留或删除旧文件。

