#!/usr/bin/env python
# -*- coding: UTF-8 -*-

"""
@Project: NarratoAI
@File   : narration_generation.py
@Author : viccy同学
@Date   : 2025/1/7
@Description: 通用短视频解说文案生成提示词（优化版v2.0）
"""

from ..base import TextPrompt, PromptMetadata, ModelType, OutputFormat


class NarrationGenerationPrompt(TextPrompt):
    """通用短视频解说文案生成提示词"""

    def __init__(self):
        metadata = PromptMetadata(
            name="narration_generation",
            category="documentary",
            version="v2.0",
            description="根据视频帧分析结果生成病毒式传播短视频解说文案，适用于各类题材内容",
            model_type=ModelType.TEXT,
            output_format=OutputFormat.JSON,
            tags=["短视频", "解说文案", "病毒传播", "文案生成", "通用模板"],
            parameters=["video_frame_description"]
        )
        super().__init__(metadata)

        self._system_prompt = "你是一名资深的短视频解说导演和编剧，参考2025年热门解说博主（如'心中之城'、'小片片说剧'、'@维C动物园'等）的成功经验，深谙病毒式传播规律和用户心理，擅长创作让人停不下来的高粘性解说内容。"

    def get_template(self) -> str:
        return """作为一名短视频解说导演，你需要深入理解病毒式传播的核心规律。以下是爆款短视频解说的核心技巧：

<viral_techniques>
## 黄金三秒法则
开头 3 秒决定用户是否继续观看，必须立即抓住注意力。

## 十大爆款开头钩子类型：
1. **悬念式**："你绝对想不到接下来会发生什么..."
2. **反转式**："所有人都以为...但真相却是..."
3. **数字冲击**："仅用 3 步/5 分钟/1 个技巧..."
4. **痛点切入**："还在为...发愁吗？"
5. **惊叹式**："太震撼了！这才是..."
6. **疑问引导**："为什么...？答案让人意外"
7. **对比冲突**："新手 VS 高手，差距竟然这么大"
8. **秘密揭露**："内行人才知道的..."
9. **情感共鸣**："有多少人和我一样..."
10. **颠覆认知**："原来我们一直都错了..."

## 解说文案核心要素（整合2025年热门博主成功经验）：
- **"你"和"我"高频使用**：把"观众朋友们"换成"你"，把"本视频将展示"换成"我发现..."，拉近距离
- **具象化表达**：别说"这个产品非常高效"，换成"早上倒进去豆子，刷牙的功夫，香浓豆浆就怼到你面前了"
- **节奏感**：短句为主，控制在 12-18 字/句，朗朗上口，语速适中（每分钟200-250字）
- **画面感**：用具体动作和细节描述，避免抽象概念，多用动词（"冲向"、"跃起"、"凝视"）和形容词（"惊人的"、"震撼的"）
- **情绪起伏**：制造期待、惊喜、满足的情绪曲线，每10秒至少有一个情绪转折，每10分钟设置一个爆点
- **信息密度**：每 3-5 秒一个信息点，保持新鲜感，避免冗余
- **口语化**：像朋友聊天，避免书面语和专业术语，多用"这个"、"那个"、"就"、"其实"、"真的"等口语词
- **留白艺术**：关键时刻停顿，让画面说话，重要视觉冲击处减少文案，关键画面后沉默1-2秒
- **网络用语**：适当使用"太XX了"、"真的"、"简直"等网络表达，增强亲近感
- **变速艺术**：信息密集处适当放慢语速，高能瞬间突然加速
- **情感共鸣**：用"这就是我""被甲方PUA实录""等表达，让观众产生"这就是我"的共鸣

## 结构范式：
【开头】钩子引入（0-3秒）→ 【发展】情节推进（3-30秒）→ 【高潮】惊艳时刻（30-45秒）→ 【收尾】强化记忆/引导互动（45-60秒）
</viral_techniques>

<video_frame_description>
${video_frame_description}
</video_frame_description>

**⚠️ 关键要求（必须严格遵守）**：
1. **严格基于实际视频帧描述生成**：只能使用帧描述中真实出现的主体、动作、环境。若帧描述提到“条纹背的小型啮齿动物在树桩啃坚果”，解说必须围绕该啮齿动物、坚果、林地展开，不能改写成“猪圈里吃饲料”。

2. **不可套用模板经验**：模板名称仅决定风格，不决定内容。即使选择“动物世界”模板，但画面是城市/人物/风景，就要写对应内容；同理，纪录片模板遇到动物画面也要写动物内容。

3. **名词动词逐条匹配**：
   - 画面描述里的每个关键名词、动作都要在解说中准确反映，可使用“条纹背啮齿动物”“蓬松尾巴”等特征词。
   - 如果帧描述无法确定具体物种，可在文案里说明“不确定的某类动物，具有××特征”，不要随意命名。
   - 严禁出现“画面是某动物静坐，解说却写狮子捕猎”之类错配。

现在，请基于 <video_frame_description> 中的**实际视频内容**，创作一段符合病毒式传播规律的解说文案。

<creation_guide>
**创作步骤：**
1. **首先仔细阅读视频帧描述**，准确理解画面中实际包含的内容（人物、动物、场景、行为等）
2. **确定内容类型**：根据画面描述判断是生活场景、动物世界、美食制作等
3. 分析视频主题和核心亮点（基于实际画面，不能虚构）
4. 选择最适合的开头钩子类型（必须与画面内容匹配）
5. 提炼每个画面的最吸引人的细节（必须是画面中真实存在的）
6. 设计情绪曲线和节奏变化（基于实际画面变化）
7. 确保解说与画面高度同步（画面是什么，解说什么）

**片段数量控制要求（重要）**：
- 片段数量应该与视频时长和内容密度匹配，不能过度细分
- 每个片段的时长建议在3-8秒之间
- **如果视频总时长很短（如10-20秒），片段数量应该控制在5-8个以内**
- **如果视频有17个关键帧，建议生成5-8个片段，而不是15个片段**
- 避免过度细分，将相似内容的连续帧合并为一个片段
- 每个片段应该覆盖3-5秒的视频时长，而不是每帧一个片段
- 合并相似内容的连续帧观察，避免为每个帧都创建独立片段

**必须遵循的创作原则（严格遵守）：**
- **开头前3秒**：必须使用钩子技巧，禁止平铺直叙，必须制造悬念或冲突
- **字数控制**：根据片段时长动态调整，每0.3-0.35秒一个字（对应每分钟180-220字语速）
- **句式要求**：短句为主（12-18字），避免长难句，多用逗号分隔
- **用词要求**：多用动词（"冲向"、"跃起"、"追逐"）和形容词（"惊人的"、"震撼的"），少用名词堆砌
- **悬念制造**：每10-15秒设置一个小悬念，保持观众注意力
- **画面同步**：解说与画面高度同步，不能出现描述滞后或超前
- **关键时刻**：视觉高潮处精简文案（甚至留白1-2秒），让画面自己说话
- **动态字幕提示**：重点关键词要加大加粗变色（在后期剪辑时实现）
- **"标重点"提示**：说到具体物件时，用圆圈、箭头高亮标出（在后期剪辑时实现）
- **结尾互动**：自然引导点赞、评论、关注，不要生硬，可以："看到这里的朋友记得点个赞"、"你们觉得呢？"
</creation_guide>

请使用以下 JSON 格式输出：

<output>
{
  "items": [
    {
        "_id": 1,
        "timestamp": "00:00:05,390-00:00:10,430",
        "picture": "画面描述",
        "narration": "解说文案"
    }
  ]
}
</output>

**片段数量控制说明**：
- 如果视频帧描述包含多个片段（如"## 片段 1"、"## 片段 2"等），每个片段应该对应一个items中的元素
- 如果视频帧描述包含17个关键帧，应该将它们合并为5-8个片段，而不是15个片段
- 合并相似内容的连续帧观察，每个片段覆盖3-5秒的视频时长
- 避免为每个关键帧都创建独立片段

<restriction>
1. 只输出 JSON 内容，不要输出其他任何说明性文字、代码块标记或解释
2. 解说文案使用简体中文，必须口语化，像日常聊天
3. **严禁虚构画面**：所有画面描述必须严格从 <video_frame_description> 中提取，不能添加任何视频中没有的内容
4. **严禁虚构时间戳**：所有时间戳必须严格从 <video_frame_description> 中提取
5. **画面与解说必须完全匹配**：解说的内容必须与picture字段描述的画面完全一致，不能出现画面是A但解说是B的情况。例如：如果画面描述是"室内客厅场景，男子在沙发旁"，解说就不能是关于"非洲草原、狮子"的内容
6. **第一条片段**：开头3秒必须使用钩子技巧，禁止"这是"、"我们看到"等平淡开场
7. 每个片段的解说文案要与画面内容精准匹配，不能提前或滞后，必须基于实际的画面内容创作
8. **禁止主题错误**：不能因为选择了某个模板类型就生成与该类型相关但画面中不存在的内容。必须严格基于实际画面描述生成解说
9. 保持解说的连贯性、故事性和节奏感，段落间用"而"、"突然"、"就在这时"等连接
10. **字数严格控制**：根据时间戳计算，每0.3-0.35秒一个字（约每分钟200字语速），例如5秒片段约15-18字
11. **单句长度**：控制在12-18字，避免超长句子，多用短句
12. 视觉高潮处适当精简文案或留白，让画面自己说话
13. **口语化要求**：多用"这个"、"那个"、"就"、"其实"、"真的"、"太XX了"等口语词
14. 整体风格必须符合抖音、B站、YouTube等主流短视频平台的爆款特征
15. **禁止书面语**：避免"因此"、"然而"、"此外"等正式词汇，改用"所以"、"但是"、"还有"
16. **验证检查**：生成后检查每个片段的narration是否与对应的picture描述的内容匹配，如果出现不匹配，必须重新生成
</restriction>"""
